---
title: 'Goè¯­è¨€æ€§èƒ½è°ƒè¯•æ–¹æ³•'
date: '2021-08-23'
tags: ['è§£å†³æ–¹æ³•']
draft: false
images: ['/static/images/twitter-card.png']
summary: 'Goè¯­è¨€å†…ç½®æ€§èƒ½è°ƒè¯•å·¥å…·å’Œæ–¹æ³•æµ‹è¯•'
---

<TOCInline toc={props.toc} exclude="Introduction" />

### ä¸€ã€å‡†å¤‡å·¥ä½œ

- å®‰è£… graphviz
  - `brew install graphviz`
- å°† $ GOPATH/bin åŠ å…¥ $PATH
  - Mac OSï¼šåœ¨ .bash_profile ä¸­ä¿®æ”¹è·¯å¾„
- å®‰è£… go-torchï¼ˆç«ç‚¬å›¾ï¼‰
  - go get github.com/uber/go-torch
  - ä¸‹è½½å¹¶å¤åˆ¶ flamegraph.pl (https://github.com/brendangregg/FlameGraph) è‡³ $GOPATH/bin è·¯å¾„ä¸‹
  - å°† $GOPATH/bin åŠ å…¥ $PATH

### äºŒã€æ€§èƒ½è°ƒä¼˜æ­¥éª¤å’Œæ–¹æ³•

ç¤ºä¾‹ä»£ç ï¼šhttps://github.com/shiiiiyd/csgo/blob/main/tools/file/prof.go

#### 1ã€build ç¨‹åº

é¦–å…ˆä½¿ç”¨ `go build prof.go` å‘½ä»¤æ„å»ºprof.go æ–‡ä»¶ï¼Œç„¶åè¿è¡Œæ„å»ºå¥½çš„profï¼Œä½¿ç”¨ `ls` å‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°å½“å‰ç›®å½•ä¸‹ä¼šå¤šå‡ºå‡ ä¸ªæ–‡ä»¶ï¼ŒåŒ…å«ï¼šcpu.profã€goroutine.profã€mem.profæ–‡ä»¶

#### 2ã€ä½¿ç”¨pprofå‘½ä»¤æŸ¥çœ‹æ€§èƒ½

**æŸ¥çœ‹CPUä½¿ç”¨æƒ…å†µï¼š**

```visual basic
csgo/tools/file on î‚  main [!+?] via ğŸ¹ v1.17.12 took 2s 
â¯ ls
cpu.prof       goroutine.prof mem.prof       prof           prof.go

csgo/tools/file on î‚  main [!+?] via ğŸ¹ v1.17.12 
â¯ go tool pprof prof cpu.prof		## è¿›å…¥pprofå‘½ä»¤
File: prof
Type: cpu
Time: Jul 28, 2022 at 12:27pm (CST)
Duration: 907.52ms, Total samples = 760ms (83.74%)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof)
(pprof) top			## top å‘½ä»¤æŸ¥çœ‹ cpu æ€§èƒ½
Showing nodes accounting for 760ms, 100% of 760ms total
Showing top 10 nodes out of 21
      flat  flat%   sum%        cum   cum%
     720ms 94.74% 94.74%      730ms 96.05%  main.fillMatrix
      20ms  2.63% 97.37%       20ms  2.63%  main.calculate (inline)
      10ms  1.32% 98.68%       10ms  1.32%  math/rand.(*rngSource).Int63
      10ms  1.32%   100%       10ms  1.32%  runtime.(*spanSet).pop
         0     0%   100%      760ms   100%  main.main
         0     0%   100%       10ms  1.32%  math/rand.(*Rand).Int31 (inline)
         0     0%   100%       10ms  1.32%  math/rand.(*Rand).Int31n
         0     0%   100%       10ms  1.32%  math/rand.(*Rand).Int63 (inline)
         0     0%   100%       10ms  1.32%  math/rand.(*Rand).Intn
         0     0%   100%       10ms  1.32%  os.Create (inline)
(pprof)
(pprof)
(pprof) list fillMatrix     ## æŸ¥çœ‹fillMatrixå…·ä½“è€—è´¹æ—¶é—´çš„ä»£ç ç‰‡æ®µ
Total: 760ms
ROUTINE ======================== main.fillMatrix in /Users/shiyd/go/src/github.com/csgo/tools/file/prof.go
     720ms      730ms (flat, cum) 96.05% of Total
         .          .     19:func fillMatrix(m *[row][col]int) {
         .          .     20:   s := rand.New(rand.NewSource(time.Now().UnixNano()))
         .          .     21:
         .          .     22:   for i := 0; i < row; i++ {
         .          .     23:           for j := 0; j < col; j++ {
     720ms      730ms     24:                   m[i][j] = s.Intn(100000)
         .          .     25:           }
         .          .     26:   }
         .          .     27:}
         .          .     28:
         .          .     29:func calculate(m *[row][col]int) {
(pprof) 
(pprof)
```

**ç”ŸæˆSVGå›¾**

```visual basic
## svg å‘½ä»¤æ˜¯æ˜¾ç¤º graphviz è¾“å‡ºçš„svgæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ˜¯å¯ä»¥æŸ¥çœ‹ä»£ç è€—è´¹çš„æ—¶é—´
(pprof) svg		
Generating report in profile001.svg
(pprof)exit
```



**æŸ¥çœ‹å†…å­˜å ç”¨ï¼ˆmemï¼‰æƒ…å†µï¼š**

```visual basic
csgo/tools/file on î‚  main [!+?] via ğŸ¹ v1.17.12 
â¯ go tool pprof prof mem.prof 
File: prof
Type: inuse_space
Time: Jul 28, 2022 at 12:27pm (CST)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof) 
(pprof) top
Showing nodes accounting for 3233.64kB, 100% of 3233.64kB total
Showing top 10 nodes out of 19
      flat  flat%   sum%        cum   cum%
 1184.27kB 36.62% 36.62%  1184.27kB 36.62%  runtime/pprof.StartCPUProfile
 1025.12kB 31.70% 68.33%  1025.12kB 31.70%  runtime.allocm
  512.20kB 15.84% 84.17%   512.20kB 15.84%  runtime.malg
  512.04kB 15.83%   100%   512.04kB 15.83%  runtime.bgscavenge
         0     0%   100%  1184.27kB 36.62%  main.main
         0     0%   100%  1184.27kB 36.62%  runtime.main
         0     0%   100%   512.56kB 15.85%  runtime.mcall
         0     0%   100%   512.56kB 15.85%  runtime.mstart
         0     0%   100%   512.56kB 15.85%  runtime.mstart0
         0     0%   100%   512.56kB 15.85%  runtime.mstart1
(pprof) 
(pprof) list main.main
Total: 3.16MB
ROUTINE ======================== main.main in /Users/shiyd/go/src/github.com/csgo/tools/file/prof.go
         0     1.16MB (flat, cum) 36.62% of Total
         .          .     41:   if err != nil {
         .          .     42:           log.Fatal("could not create CPU profile: ", err)
         .          .     43:   }
         .          .     44:
         .          .     45:   // è·å–ç³»ç»Ÿä¿¡æ¯
         .     1.16MB     46:   if err := pprof.StartCPUProfile(f); err != nil { //ç›‘æ§cpu
         .          .     47:           log.Fatal("could not start CPU profile: ", err)
         .          .     48:   }
         .          .     49:   defer pprof.StopCPUProfile()
         .          .     50:
         .          .     51:   // ä¸»é€»è¾‘åŒºï¼Œè¿›è¡Œä¸€äº›ç®€å•çš„ä»£ç è¿ç®—
(pprof) 
(pprof) 
```



#### 3ã€ä½¿ç”¨ flame graphs æŸ¥çœ‹

**go-torch å‘½ä»¤**

ä½¿ç”¨`go-torch cpu.prof` å‘½ä»¤ç”Ÿæˆç«ç„°å›¾

```bash
â¯ go-torch cpu.prof
INFO[10:03:05] Run pprof command: go tool pprof -raw -seconds 30 cpu.prof
INFO[10:03:05] Writing svg to torch.svg
```



### ä¸‰ã€é€šè¿‡HTTPæ–¹å¼è¾“å‡ºProfile

ä¸Šé¢çš„æ–¹å¼é€‚ç”¨äºéè¿è¡Œæ—¶çš„æœåŠ¡ï¼Œå¦‚æœæ˜¯è¿è¡Œæ—¶çš„æœåŠ¡åˆ™å¯ä»¥é€šè¿‡HTTPè®¿é—®çš„æ–¹å¼è¾“å‡ºProfile æ–‡ä»¶æŸ¥çœ‹ã€‚

- ç®€å•ï¼Œé€‚ç”¨äºæŒç»­æ€§è¿è¡Œçš„åº”ç”¨

- åœ¨åº”ç”¨ç¨‹åºä¸­å¯¼å…¥ import _ "net/http/pprof"ï¼Œå¹¶å¯åŠ¨ http server å³å¯

  - httpè°ƒç”¨ï¼š`import _ "net/http/pprof"`
  - Gin è°ƒç”¨ï¼š`import "github.com/DeanThompson/ginpprof" ` `r := gin.Default() ginpprof.Wrap(r)`
  - ç¤ºä¾‹ï¼šgo-torch -u http://localhost:8080/ -t 30

- æµ‹è¯•å‘½ä»¤ï¼š

  - `http://<host>:<port>/debug/pprof/`

    - ç¤ºä¾‹ï¼šhttp://127.0.0.1:8081/debug/pprof

      åˆå¯èƒ½ä¸ä¼šå‡ºç°åŒ…å«blockã€mutexã€heapçš„ç•Œé¢ï¼Œéœ€è¦é‡å¯ä¸€ä¸‹æœåŠ¡

  - `go tool pprof http://<host>:<port>/debug/pprof/profile?seconds=10` (é»˜è®¤ä¸º30ç§’)

    - ç¤ºä¾‹ï¼š`go tool pprof http://127.0.0.1:8080/debug/pprof/profile -t 10`

  - `go-torch -seconds 10 http://<host>:<port>/debug/pprof/profile`



### å‚è€ƒ

[1]ï¼šhttps://pkg.go.dev/github.com/uber/go-torch@v0.0.0-20181107071353-86f327cc820e#section-readme

[2]ï¼šhttps://time.geekbang.org/course/detail/100024001-91253

[3]ï¼šhttps://ruanyifeng.com/blog/2017/09/flame-graph.html

[4]ï¼šhttps://blog.csdn.net/qq_17612199/article/details/80353355
